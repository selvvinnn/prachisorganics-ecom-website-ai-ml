{% extends 'store/base.html' %}
{% load currency %}
{% block title %}Checkout Â· Prachi's Organics{% endblock %}
{% block content %}
<section class="container mx-auto px-4 py-10">
  <h1 class="font-serif text-3xl mb-6">Checkout</h1>
    <div class="grid md:grid-cols-3 gap-8">
      <div class="md:col-span-2 bg-white p-6 rounded shadow">
       <form id="checkout-form">{% csrf_token %}
         <div class="grid md:grid-cols-2 gap-4">
           <div>
            <label class="block text-sm mb-1">First Name</label>
            <input name="first_name" class="w-full border rounded px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm mb-1">Last Name</label>
            <input name="last_name" class="w-full border rounded px-3 py-2" required>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Email</label>
            <input name="email" type="email" class="w-full border rounded px-3 py-2" required>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Address</label>
            <textarea name="address" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
          </div>
          <div>
            <label class="block text-sm mb-1">Zipcode</label>
            <input name="zipcode" class="w-full border rounded px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm mb-1">City</label>
            <input name="city" class="w-full border rounded px-3 py-2" required>
          </div>
        </div>
         <div class="mt-6 text-right">
           <button class="inline-block px-5 py-2 border border-green-500 text-brandGreen rounded-full hover:bg-green-100 hover:text-[#8B4513] transition" id="rzp-button1" type="button"> Continue to Payment</button>
        </div>
      </form>
    </div>
    <div class="bg-white p-6 rounded shadow">
  <div class="font-semibold mb-2">Order Summary</div>

  {% for item in items %}
    <div class="py-2 flex items-center justify-between">

  <div class="flex items-center gap-3">
    <!-- Product Image -->
    <img 
      src="{{ item.product.image.url }}" 
      alt="{{ item.product.name }}"
      class="w-12 h-12 object-cover rounded border"
    />

    <!-- Product Name + Qty -->
    <div class="text-sm">
      {{ item.product.name }} x {{ item.quantity }}
    </div>
  </div>

  <!-- Price -->
  <div class="text-sm font-semibold">
    {{ item.line_total|inr }}
  </div>

</div>

  {% endfor %}

  <!-- ðŸŸ¢ COUPON INPUT -->
  <form method="GET" class="mt-4 flex gap-2">
    <input 
      type="text" 
      name="coupon" 
      placeholder="Enter coupon code" 
      class="border px-3 py-2 rounded w-full"
      value="{{ applied_coupon|default:'' }}">
    <button class="border border-green-500 bg-brandGreen hover:bg-green-100 hover:text-[#8B4513] text-black px-4 py-2 rounded">Apply</button>
  </form>

  <!-- ðŸŸ¢ Show applied coupon -->
  {% if applied_coupon %}
    <div class="mt-2 text-green-600 text-sm">
      Coupon <strong>{{ applied_coupon }}</strong> applied
    </div>
  {% endif %}

  <div class="mt-4 flex justify-between">
    <div>Subtotal</div>
    <div class="font-semibold">{{ subtotal|inr }}</div>
  </div>

  {% if discount_amount > 0 %}
    <div class="mt-2 flex justify-between text-green-600">
      <div>Discount</div>
      <div>- {{ discount_amount|inr }}</div>
    </div>

    <div class="mt-2 flex justify-between font-bold text-lg">
      <div>Final Total</div>
      <div>{{ final_amount|inr }}</div>
    </div>
  {% endif %}
</div>


<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
 const form = document.getElementById('checkout-form');
 document.getElementById('rzp-button1').addEventListener('click', function (e) {
     e.preventDefault();

     if (!form.checkValidity()) {
         form.reportValidity();
         return;
     }

    var options = {
        "key": "rzp_live_RYXIOhLxjO9TQW", // your Razorpay key
        "amount": "{{ payment.amount }}",
        "currency": "INR",
        "name": "Prachi's Organics",
        "description": "Order Payment",
        "order_id": "{{ payment.id }}",
        "prefill": {
            "name": form.first_name.value + " " + form.last_name.value,
            "email": form.email.value,
        },
         "handler": function (response) {

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
          
             data.razorpay_order_id = response.razorpay_order_id;
             data.razorpay_payment_id = response.razorpay_payment_id;
             data.razorpay_signature = response.razorpay_signature;

             fetch("/checkout/", {
                 method: "POST",
                 headers: {
                     "Content-Type": "application/json",
                     "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                 },
                 body: JSON.stringify(data)
             })
             .then(res => res.json())
             .then(data => {
                 if (data.status === 'success') {
                     window.location.href = data.redirect_url;
                 } else {
                     alert("Payment verification failed: " + data.message);
                 }
             })
             .catch(err => {
                 alert("Error verifying payment: " + err);
             });
         },
        "theme": {
            "color": "#3399cc"
        }
    };

    // âœ… 4. Open Razorpay only if form was valid
    var rzp1 = new Razorpay(options);
    rzp1.open();
});
</script>


</section>
{% endblock %}
