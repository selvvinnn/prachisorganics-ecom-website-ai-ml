{% extends 'store/base.html' %}
{% load currency %}
{% block title %}Checkout Â· Prachi's Organics{% endblock %}

{% block content %}
<section class="container mx-auto px-4 py-10">
  <h1 class="font-serif text-3xl mb-6">Checkout</h1>

  <div class="grid md:grid-cols-3 gap-8">

    <!-- LEFT: ADDRESS + PAYMENT -->
    <div class="md:col-span-2 bg-white p-6 rounded shadow">
      <form id="checkout-form">{% csrf_token %}

        <!-- ADDRESS -->
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">First Name</label>
            <input name="first_name" class="w-full border rounded px-3 py-2" required>
          </div>

          <div>
            <label class="block text-sm mb-1">Last Name</label>
            <input name="last_name" class="w-full border rounded px-3 py-2" required>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Email</label>
            <input name="email" type="email" class="w-full border rounded px-3 py-2" required>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Address</label>
            <textarea name="address" class="w-full border rounded px-3 py-2" rows="3" required></textarea>
          </div>

          <div>
            <label class="block text-sm mb-1">Zipcode</label>
            <input name="zipcode" class="w-full border rounded px-3 py-2" required>
          </div>

          <div>
            <label class="block text-sm mb-1">City</label>
            <input name="city" class="w-full border rounded px-3 py-2" required>
          </div>
        </div>

        <!-- PAYMENT METHOD -->
        <div class="mt-6">
          <label class="block font-semibold mb-2">Payment Method</label>

          <div class="flex flex-col gap-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="payment_method" value="razorpay" checked>
              Pay Online (UPI / Card / Netbanking)
            </label>

            <label class="flex items-center gap-2">
              <input type="radio" name="payment_method" value="cod">
              Cash on Delivery (â‚¹50 shipping)
            </label>
          </div>
        </div>

        <!-- BUTTON -->
        <div class="mt-6 text-right">
          <button
            id="checkout-btn"
            type="button"
            class="inline-block px-5 py-2 border border-green-500 text-brandGreen rounded-full hover:bg-green-100 hover:text-[#8B4513] transition">
            Continue
          </button>
        </div>

      </form>
    </div>

    <!-- RIGHT: ORDER SUMMARY -->
    <div class="bg-white p-6 rounded shadow">
      <div class="font-semibold mb-3">Order Summary</div>

      {% for item in items %}
      <div class="py-2 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="{{ item.product.image.url }}" class="w-12 h-12 object-cover rounded border">
          <div class="text-sm">{{ item.product.name }} x {{ item.quantity }}</div>
        </div>
        <div class="text-sm font-semibold">{{ item.line_total|inr }}</div>
      </div>
      {% endfor %}

      <!-- COUPON -->
      <form method="GET" class="mt-4 flex gap-2">
        <input type="text" name="coupon" placeholder="Enter coupon code"
          class="border px-3 py-2 rounded w-full"
          value="{{ applied_coupon|default:'' }}">
        <button class="border border-green-500 bg-brandGreen text-black px-4 py-2 rounded">
          Apply
        </button>
      </form>

      {% if applied_coupon %}
        <div class="mt-2 text-green-600 text-sm">
          Coupon <strong>{{ applied_coupon }}</strong> applied
        </div>
      {% endif %}

      <div class="mt-4 flex justify-between">
        <div>Subtotal</div>
        <div class="font-semibold">{{ subtotal|inr }}</div>
      </div>

      {% if discount_amount > 0 %}
      <div class="mt-2 flex justify-between text-green-600">
        <div>Discount</div>
        <div>- {{ discount_amount|inr }}</div>
      </div>
      {% endif %}

      <div id="shipping-row" class="mt-2 flex justify-between hidden">
        <div>Shipping</div>
        <div>â‚¹50</div>
      </div>

      <div class="flex justify-between font-bold text-lg">
        <div>Total</div>
        <div>{{ final_amount|inr }}</div>
      </div>
    </div>
  </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const form = document.getElementById("checkout-form");
const checkoutBtn = document.getElementById("checkout-btn");
const shippingRow = document.getElementById("shipping-row");
const finalTotal = document.getElementById("final-total");

const BASE_AMOUNT = Number("{{ final_amount|default:subtotal }}");
const COD_SHIPPING = 50;

// ðŸ” Toggle shipping for COD
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
  radio.addEventListener("change", () => {
    if (radio.value === "cod" && radio.checked) {
      shippingRow.classList.remove("hidden");
      finalTotal.innerText = "â‚¹" + (BASE_AMOUNT + COD_SHIPPING);
    } else {
      shippingRow.classList.add("hidden");
      finalTotal.innerText = "â‚¹" + BASE_AMOUNT;
    }
  });
});

checkoutBtn.addEventListener("click", function (e) {
  e.preventDefault();

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const method = document.querySelector('input[name="payment_method"]:checked').value;

  // ================= COD FLOW =================
  if (method === "cod") {
    const data = new FormData(form);

    fetch("/checkout/cod/", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: data
    })
    .then(res => res.json())
    .then(res => {
      if (res.status === "success") {
        window.location.href = "/order-success/";
      } else {
        alert(res.message || "Failed to place COD order");
      }
    })
    .catch(() => alert("Something went wrong"));
    return;
  }

  // ================= RAZORPAY FLOW =================
  var options = {
    key: "rzp_live_RYXIOhLxjO9TQW",
    amount: "{{ payment.amount }}",
    currency: "INR",
    name: "Prachi's Organics",
    order_id: "{{ payment.id }}",
    handler: function (response) {

      const data = new FormData(form);
      data.append("razorpay_order_id", response.razorpay_order_id);
      data.append("razorpay_payment_id", response.razorpay_payment_id);
      data.append("razorpay_signature", response.razorpay_signature);

      fetch("/checkout/", {
        method: "POST", 
        headers: { "X-CSRFToken": csrfToken },
        body: data
      })
      .then(res => res.json())
      .then(res => {
        if (res.status === "success") {
          window.location.href = "/order-success/";
        } else {
          alert(res.message || "Payment failed");
        }
      });
    }
  };

  new Razorpay(options).open();
});
</script>

{% endblock %}
